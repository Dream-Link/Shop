<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§¶‡•Å‡§ï‡§æ‡§® ‡§∞‡•á‡§ü ‡§Æ‡•à‡§®‡•á‡§ú‡§∞ V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }
        
        .alphabet-overlay {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px 0 0 10px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .alphabet-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .alphabet-scroll {
            position: fixed;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .alphabet-scroll.show {
            opacity: 1;
            visibility: visible;
        }
        
        .long-press-menu {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 100;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s ease;
        }
        
        .long-press-menu.show {
            opacity: 1;
            transform: scale(1);
        }
        
        @media (prefers-color-scheme: dark) {
            .long-press-menu {
                background: #374151;
                color: white;
            }
        }
        
        .item-card {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .variety-item {
            border-left: 3px solid #3b82f6;
            padding-left: 8px;
            margin: 4px 0;
        }

        .calc-btn {
            touch-action: manipulation;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        /* Theme styles */
        .theme-grayscale {
            filter: grayscale(100%);
        }

        .theme-light {
            background: #f8fafc !important;
            color: #1f2937 !important;
        }

        .theme-dark {
            background: #1f2937 !important;
            color: #f9fafb !important;
        }

        .theme-dark .bg-white {
            background: #374151 !important;
        }

        .theme-dark .text-gray-800 {
            color: #f9fafb !important;
        }

        .theme-dark .border-gray-200 {
            border-color: #4b5563 !important;
        }

        /* Full screen modal styles */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            overflow-y: auto;
        }

        .theme-dark .fullscreen-modal {
            background: #1f2937 !important;
        }

        .theme-grayscale .fullscreen-modal {
            background: white !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-md relative">
        <!-- Header with Menu -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-4 flex justify-between items-center transition-colors duration-300">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <button onclick="toggleMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div id="menuDropdown" class="hidden absolute left-0 top-12 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-600 w-56 z-50">
                        <button onclick="openCalculator()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                            <span>üßÆ</span>
                            <span>‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</span>
                        </button>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <button onclick="openBillHistory()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                            <span>üìã</span>
                            <span>‡§™‡§∞‡•ç‡§ö‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</span>
                        </button>
                        <button onclick="openBakayaHistory()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                            <span>üí≥</span>
                            <span>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</span>
                        </button>
                        <button onclick="openAllItemsView()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                            <span>üìã</span>
                            <span>‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§¶‡•á‡§ñ‡•á‡§Ç</span>
                        </button>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <button onclick="editShopName()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                            <span>‚úèÔ∏è</span>
                            <span>‡§¶‡•Å‡§ï‡§æ‡§® ‡§®‡§æ‡§Æ ‡§è‡§°‡§ø‡§ü</span>
                        </button>
                        <div class="relative">
                            <button onclick="toggleThemeMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-between text-gray-800 dark:text-white">
                                <div class="flex items-center space-x-2">
                                    <span>üé®</span>
                                    <span>‡§•‡•Ä‡§Æ</span>
                                </div>
                                <span>‚ñ∂</span>
                            </button>
                            <div id="themeSubmenu" class="hidden absolute left-full top-0 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-600 w-40 ml-1">
                                <button onclick="setTheme('auto')" class="w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm text-gray-800 dark:text-white">üîÑ ‡§ë‡§ü‡•ã</button>
                                <button onclick="setTheme('light')" class="w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm text-gray-800 dark:text-white">‚òÄÔ∏è ‡§≤‡§æ‡§á‡§ü</button>
                                <button onclick="setTheme('dark')" class="w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm text-gray-800 dark:text-white">üåô ‡§°‡§æ‡§∞‡•ç‡§ï</button>
                                <button onclick="setTheme('grayscale')" class="w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm text-gray-800 dark:text-white">‚ö´ ‡§ó‡•ç‡§∞‡•á ‡§∏‡•ç‡§ï‡•á‡§≤</button>
                            </div>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <button onclick="clearAllItems()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-red-600 dark:text-red-400">
                            <span>üóëÔ∏è</span>
                            <span>‡§∏‡§≠‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç</span>
                        </button>
                    </div>
                </div>
                <div>
                    <h1 id="shopTitle" class="text-xl font-bold text-gray-800 dark:text-white">üè™ ‡§¶‡•Å‡§ï‡§æ‡§® ‡§∞‡•á‡§ü</h1>
                </div>
            </div>
            <div class="relative">
                <button onclick="toggleAddMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200" title="‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                </button>
                <div id="addMenuDropdown" class="hidden absolute right-0 top-12 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-600 w-48 z-50">
                    <button onclick="openAddModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                        <span>‚ûï</span>
                        <span>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</span>
                    </button>
                    <button onclick="openBillModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                        <span>üìÑ</span>
                        <span>‡§™‡§∞‡•ç‡§ö‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç</span>
                    </button>
                    <button onclick="openBakayaModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center space-x-2 text-gray-800 dark:text-white">
                        <span>üí∞</span>
                        <span>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-3 mb-4 transition-colors duration-300">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="‡§µ‡§∏‡•ç‡§§‡•Å ‡§ñ‡•ã‡§ú‡•á‡§Ç..." 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                       oninput="searchItems()" onfocus="showAlphabetScroll()" onblur="hideAlphabetScroll()">
                <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <!-- Items List -->
        <div class="space-y-3">
            <div id="itemsList">
                <!-- Items will be displayed here -->
            </div>
            <div id="emptyState" class="text-center py-12 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-xl shadow-md transition-colors duration-300">
                <div class="text-4xl mb-2">üìù</div>
                <p class="font-medium">‡§ï‡•ã‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</p>
                <p class="text-sm">‡§ä‡§™‡§∞ ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§∏‡•á ‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</p>
            </div>
            <div id="noResults" class="hidden text-center py-8 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-xl shadow-md transition-colors duration-300">
                <div class="text-3xl mb-2">üîç</div>
                <p>‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</p>
            </div>
        </div>
    </div>

    <!-- Alphabet Scroll -->
    <div id="alphabetScroll" class="alphabet-scroll flex flex-col space-y-1">
        <!-- Alphabet buttons will be generated here -->
    </div>

    <!-- Alphabet Overlay -->
    <div id="alphabetOverlay" class="alphabet-overlay">
        <div id="currentLetter" class="text-2xl font-bold"></div>
    </div>

    <!-- Long Press Menu -->
    <div id="longPressMenu" class="long-press-menu hidden">
        <button onclick="editItemFromMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2 rounded-t-xl">
            <span>‚úèÔ∏è</span>
            <span>‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</span>
        </button>
        <button onclick="addVarietyFromMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2">
            <span>‚ûï</span>
            <span>‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</span>
        </button>
        <button onclick="showItemHistory()" class="w-full px-4 py-3 text-left hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2">
            <span>üìä</span>
            <span>‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç</span>
        </button>
        <button onclick="deleteItemFromMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2 text-red-600 dark:text-red-400 rounded-b-xl">
            <span>üóëÔ∏è</span>
            <span>‡§π‡§ü‡§æ‡§è‡§Ç</span>
        </button>
    </div>

    <!-- Add Item Modal -->
    <div id="addModal" class="hidden fullscreen-modal dark:bg-gray-800 transition-colors duration-300">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
                <button onclick="closeAddModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 max-w-md mx-auto">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                    <input type="text" id="itemName" placeholder="‡§ú‡•à‡§∏‡•á: ‡§ö‡§æ‡§µ‡§≤, ‡§¶‡§æ‡§≤, ‡§ö‡•Ä‡§®‡•Ä..." 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                </div>

                <!-- Multiple Rate Inputs -->
                <div id="rateInputs">
                    <div class="rate-input-group border border-gray-200 dark:border-gray-600 rounded-lg p-3 mb-3">
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="variety-rate-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" placeholder="‡§ú‡•à‡§∏‡•á: ‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§∞‡•ç‡§ö, ‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö...">
                        </div>
                        <div class="flex space-x-2">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§∞‡•á‡§ü/‡§≠‡§æ‡§µ</label>
                                <input type="number" class="rate-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="50">
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§Ø‡•Ç‡§®‡§ø‡§ü</label>
                                <select class="unit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã</option>
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ">‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó">‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó</option>
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞">‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞</option>
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü</option>
                                    <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®">‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="addRateInput()" class="text-blue-600 dark:text-blue-400 text-sm hover:underline">+ ‡§î‡§∞ ‡§∞‡•á‡§ü ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                
                <div class="pt-2">
                    <button onclick="addItem()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        ‚ûï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Modal -->
    <div id="billModal" class="hidden fullscreen-modal dark:bg-gray-800 transition-colors duration-300">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">üìÑ ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç</h3>
                <button onclick="closeBillModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="max-w-md mx-auto">
                <div id="billItems" class="space-y-3 mb-6">
                    <!-- Bill items will be added here -->
                </div>
                
                <div class="flex space-x-2 mb-6">
                    <input type="number" id="billAmount" placeholder="‚Çπ ‡§∞‡•Å‡§™‡§Ø‡•á *" required
                           class="w-24 px-3 py-2 border border-red-300 dark:border-red-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white"
                           onkeypress="if(event.key==='Enter') focusProductInput()">
                    <input type="text" id="billProduct" placeholder="‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" 
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white"
                           onkeypress="if(event.key==='Enter') addBillItem()">
                    <button onclick="addBillItem()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‚ûï
                    </button>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-gray-800 dark:text-white">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</span>
                        <span id="billTotal" class="text-xl font-bold text-blue-600 dark:text-blue-400">‚Çπ0</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="saveBill()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üíæ ‡§∏‡•á‡§µ
                        </button>
                        <button onclick="saveBillImage()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üì∑ ‡§á‡§Æ‡•á‡§ú
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="printBill()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
                        </button>
                        <button onclick="shareBillPDF()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üì§ ‡§∂‡•á‡§Ø‡§∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bakaya Modal -->
    <div id="bakayaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden transition-colors duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">üí∞ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä</h3>
            </div>
            
            <div class="p-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§¨‡§ï‡§æ‡§Ø‡§æ‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                        <input type="text" id="bakayaName" placeholder="‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø *</label>
                        <input type="number" id="bakayaAmount" placeholder="‚Çπ ‡§∞‡•Å‡§™‡§Ø‡•á *" required
                               class="w-full px-3 py-2 border border-red-300 dark:border-red-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡§ø‡§µ‡§∞‡§£ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                        <textarea id="bakayaDescription" placeholder="‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£..." rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="saveBakaya()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üíæ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                    <button onclick="saveBakayaImage()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üì∑ ‡§á‡§Æ‡•á‡§ú
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="printBakaya()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
                    </button>
                    <button onclick="shareBakayaPDF()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üì§ ‡§∂‡•á‡§Ø‡§∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill History Modal -->
    <div id="billHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden transition-colors duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">üìã ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</h3>
            </div>
            
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div id="billHistoryList">
                    <!-- Bill history will be shown here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                <p class="text-center text-sm text-gray-600 dark:text-gray-300">‡§¨‡•à‡§ï ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</p>
            </div>
        </div>
    </div>

    <!-- Bakaya History Modal -->
    <div id="bakayaHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden transition-colors duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">üí∞ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</h3>
            </div>
            
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div id="bakayaHistoryList">
                    <!-- Bakaya history will be shown here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                <p class="text-center text-sm text-gray-600 dark:text-gray-300">‡§¨‡•à‡§ï ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</p>
            </div>
        </div>
    </div>

    <!-- All Items View Modal -->
    <div id="allItemsModal" class="hidden fullscreen-modal dark:bg-gray-800 transition-colors duration-300">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">üìã ‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§¶‡•á‡§ñ‡•á‡§Ç</h3>
                <button onclick="closeAllItemsView()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4 text-center">
                <span class="text-lg font-semibold text-blue-600 dark:text-blue-400">‡§ï‡•Å‡§≤ ‡§µ‡§∏‡•ç‡§§‡•Å‡§è‡§Ç: <span id="totalItemsCount">0</span></span>
            </div>
            
            <div class="mb-4 grid grid-cols-3 gap-2">
                <button onclick="saveAllItemsImage()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    üì∑ ‡§á‡§Æ‡•á‡§ú
                </button>
                <button onclick="printAllItems()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
                </button>
                <button onclick="shareAllItemsPDF()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    üì§ ‡§∂‡•á‡§Ø‡§∞
                </button>
            </div>
            
            <div class="max-h-[70vh] overflow-y-auto">
                <div id="allItemsList" class="space-y-3">
                    <!-- All items will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="hidden fullscreen-modal dark:bg-gray-800 transition-colors duration-300">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">üßÆ ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</h3>
                <button onclick="closeCalculator()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="max-w-sm mx-auto">
                <div class="mb-4">
                    <input type="text" id="calcDisplay" readonly 
                           class="w-full px-4 py-3 text-right text-xl font-mono bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white">
                </div>
                
                <div class="mb-4 max-h-32 overflow-y-auto">
                    <div id="calcHistory" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                        <!-- Calculator history will appear here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="clearCalc()" class="calc-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-200">C</button>
                    <button onclick="deleteLast()" class="calc-btn bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg transition duration-200">‚å´</button>
                    <button onclick="appendToCalc('/')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200">√∑</button>
                    <button onclick="appendToCalc('*')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200">√ó</button>
                    
                    <button onclick="appendToCalc('7')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">7</button>
                    <button onclick="appendToCalc('8')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">8</button>
                    <button onclick="appendToCalc('9')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">9</button>
                    <button onclick="appendToCalc('-')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200">-</button>
                    
                    <button onclick="appendToCalc('4')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">4</button>
                    <button onclick="appendToCalc('5')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">5</button>
                    <button onclick="appendToCalc('6')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">6</button>
                    <button onclick="appendToCalc('+')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200">+</button>
                    
                    <button onclick="appendToCalc('1')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">1</button>
                    <button onclick="appendToCalc('2')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">2</button>
                    <button onclick="appendToCalc('3')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">3</button>
                    <button onclick="calculateResult()" class="calc-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200 row-span-2">=</button>
                    
                    <button onclick="appendToCalc('0')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200 col-span-2">0</button>
                    <button onclick="appendToCalc('.')" class="calc-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold py-3 rounded-lg transition duration-200">.</button>
                </div>
                
                <div class="mt-4">
                    <button onclick="checkTotal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        ‚úì ‡§ö‡•á‡§ï
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm transition-colors duration-300">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">‡§µ‡§∏‡•ç‡§§‡•Å ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                    <input type="text" id="editItemName" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                </div>
                
                <div id="editVarietiesList">
                    <!-- Varieties will be shown here for editing -->
                </div>
                
                <div class="pt-2">
                    <button onclick="updateItem()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        ‚úÖ ‡§Ö‡§™‡§°‡•á‡§ü
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let items = [];
        let editingIndex = -1;
        let filteredItems = [];
        let longPressTimer;
        let currentLongPressItem = null;
        let currentReceiptItems = [];
        let receiptHistory = [];
        let bakayaHistory = [];
        let editingReceiptId = null;
        let editingBakayaId = null;
        let calcExpression = '';
        let calcResult = '';

        // Notification system
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            // Clear any existing timeout
            if (window.notificationTimeout) {
                clearTimeout(window.notificationTimeout);
            }
            
            // Force hide first
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            notification.className = 'notification';
            
            // Small delay then show new notification
            setTimeout(() => {
                notificationText.textContent = message;
                notification.className = `notification ${isError ? 'error' : ''}`;
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
                
                // Auto hide after 2.5 seconds
                window.notificationTimeout = setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    // Reset completely after animation
                    setTimeout(() => {
                        notification.className = 'notification';
                        notification.style.transform = 'translateX(100%)';
                        notification.style.opacity = '0';
                    }, 300);
                }, 2500);
            }, 100);
        }

        // Initialize app
        function initApp() {
            try {
                // Initialize arrays first
                items = [];
                receiptHistory = [];
                bakayaHistory = [];
                filteredItems = [];
                
                // Try to load from localStorage
                const savedItems = localStorage.getItem('shopItems');
                const savedReceipts = localStorage.getItem('receiptHistory');
                const savedBakaya = localStorage.getItem('bakayaHistory');
                const savedTheme = localStorage.getItem('selectedTheme');
                const savedShopName = localStorage.getItem('shopName');
                
                if (savedItems) {
                    items = JSON.parse(savedItems);
                }
                if (savedReceipts) {
                    receiptHistory = JSON.parse(savedReceipts);
                }
                if (savedBakaya) {
                    bakayaHistory = JSON.parse(savedBakaya);
                }
                if (savedTheme) {
                    currentTheme = savedTheme;
                    applyTheme(savedTheme);
                }
                if (savedShopName) {
                    document.getElementById('shopTitle').textContent = savedShopName;
                }
                
                // Ensure arrays are valid
                if (!Array.isArray(items)) items = [];
                if (!Array.isArray(receiptHistory)) receiptHistory = [];
                if (!Array.isArray(bakayaHistory)) bakayaHistory = [];
                
                // Sort and display
                items.sort((a, b) => a.name.localeCompare(b.name, 'hi'));
                filteredItems = [...items];
                
                // Display items and generate alphabet
                displayItems();
                generateAlphabet();
                
                console.log('App initialized successfully');
            } catch (e) {
                console.error('Initialization error:', e);
                items = [];
                receiptHistory = [];
                bakayaHistory = [];
                filteredItems = [];
                showNotification('‡§ê‡§™ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç', true);
            }
        }

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem('shopItems', JSON.stringify(items));
            } catch (e) {
                showNotification('‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', true);
            }
        }

        function saveReceiptHistory() {
            try {
                localStorage.setItem('receiptHistory', JSON.stringify(receiptHistory));
            } catch (e) {
                showNotification('‡§™‡§∞‡•ç‡§ö‡•Ä ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', true);
            }
        }

        function saveBakayaHistory() {
            try {
                localStorage.setItem('bakayaHistory', JSON.stringify(bakayaHistory));
            } catch (e) {
                showNotification('‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', true);
            }
        }

        // Menu functions
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('hidden');
        }

        // Add item functions
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('addMenuDropdown').classList.add('hidden');
            clearForm();
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            clearForm();
        }

        function addRateInput() {
            const rateInputs = document.getElementById('rateInputs');
            const newRateInput = document.createElement('div');
            newRateInput.className = 'rate-input-group border border-gray-200 dark:border-gray-600 rounded-lg p-3 mb-3';
            newRateInput.innerHTML = `
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                    <input type="text" class="variety-rate-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" placeholder="‡§ú‡•à‡§∏‡•á: ‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§∞‡•ç‡§ö, ‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö...">
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§∞‡•á‡§ü/‡§≠‡§æ‡§µ</label>
                        <input type="number" class="rate-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="‡§∞‡•á‡§ü">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§Ø‡•Ç‡§®‡§ø‡§ü</label>
                        <select class="unit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã</option>
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ">‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó">‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó</option>
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞">‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞</option>
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü</option>
                            <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®">‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="removeRateInput(this)" class="px-2 py-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `;
            rateInputs.appendChild(newRateInput);
        }

        function removeRateInput(button) {
            button.closest('.rate-input-group').remove();
        }

        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const rateInputGroups = document.querySelectorAll('.rate-input-group');

            if (!name) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            const varieties = [];
            
            rateInputGroups.forEach(group => {
                const varietyRateName = group.querySelector('.variety-rate-name').value.trim();
                const rateInput = group.querySelector('.rate-input').value.trim();
                const unitInput = group.querySelector('.unit-input').value;
                
                if (rateInput && !isNaN(rateInput) && parseFloat(rateInput) > 0) {
                    varieties.push({
                        name: varietyRateName || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø',
                        rates: [{
                            rate: parseFloat(rateInput),
                            unit: unitInput
                        }],
                        timestamp: new Date().toLocaleString('hi-IN')
                    });
                }
            });

            if (varieties.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∏‡§π‡•Ä ‡§∞‡•á‡§ü ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            // Check if item already exists
            const existingItemIndex = items.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
            
            if (existingItemIndex !== -1) {
                // Add varieties to existing item
                items[existingItemIndex].varieties.push(...varieties);
                showNotification('‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ú‡•ã‡§°‡§º ‡§¶‡•Ä ‡§ó‡§à!');
            } else {
                // Create new item
                const newItem = {
                    name: name,
                    varieties: varieties,
                    timestamp: new Date().toLocaleString('hi-IN')
                };
                items.push(newItem);
                showNotification('‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ú‡•ã‡§°‡§º ‡§¶‡•Ä ‡§ó‡§à!');
            }

            // Sort and update display
            items.sort((a, b) => a.name.localeCompare(b.name, 'hi'));
            saveToStorage();
            filteredItems = [...items];
            displayItems();
            generateAlphabet();
            closeAddModal();
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            const rateInputs = document.getElementById('rateInputs');
            rateInputs.innerHTML = `
                <div class="rate-input-group border border-gray-200 dark:border-gray-600 rounded-lg p-3 mb-3">
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" class="variety-rate-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" placeholder="‡§ú‡•à‡§∏‡•á: ‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§∞‡•ç‡§ö, ‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö...">
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§∞‡•á‡§ü/‡§≠‡§æ‡§µ</label>
                            <input type="number" class="rate-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§Ø‡•Ç‡§®‡§ø‡§ü</label>
                            <select class="unit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã</option>
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ">‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó">‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó</option>
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞">‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞</option>
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü</option>
                                <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®">‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Search and display functions
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredItems = [...items];
            } else {
                filteredItems = items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.varieties.some(variety => variety.name.toLowerCase().includes(searchTerm))
                );
            }
            
            displayItems();
        }

        function displayItems() {
            const itemsList = document.getElementById('itemsList');
            const emptyState = document.getElementById('emptyState');
            const noResults = document.getElementById('noResults');

            if (items.length === 0) {
                itemsList.innerHTML = '';
                emptyState.style.display = 'block';
                noResults.style.display = 'none';
                return;
            }

            if (filteredItems.length === 0) {
                itemsList.innerHTML = '';
                emptyState.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            noResults.style.display = 'none';
            
            itemsList.innerHTML = filteredItems.map((item, index) => {
                const originalIndex = items.findIndex(originalItem => originalItem.name === item.name);
                
                return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-600 overflow-hidden transition-colors duration-300 item-card" 
                     data-item-index="${originalIndex}"
                     ontouchstart="startLongPress(event, ${originalIndex})" 
                     ontouchend="endLongPress()" 
                     onmousedown="startLongPress(event, ${originalIndex})" 
                     onmouseup="endLongPress()"
                     onmouseleave="endLongPress()">
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 dark:text-white text-lg mb-2">${item.name}</h3>
                        <div class="space-y-2">
                            ${item.varieties.map(variety => `
                                <div class="variety-item">
                                    ${variety.name !== '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø' ? `<div class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">${variety.name}</div>` : ''}
                                    <div class="flex flex-wrap gap-2">
                                        ${variety.rates.map(rateInfo => `
                                            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-sm font-medium">
                                                ‚Çπ${rateInfo.rate} ${rateInfo.unit}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Long press functions
        function startLongPress(event, itemIndex) {
            event.preventDefault();
            currentLongPressItem = itemIndex;
            longPressTimer = setTimeout(() => {
                showLongPressMenu(event, itemIndex);
            }, 500);
        }

        function endLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function showLongPressMenu(event, itemIndex) {
            const menu = document.getElementById('longPressMenu');
            const rect = event.target.closest('.item-card').getBoundingClientRect();
            
            menu.style.left = `${rect.left + 10}px`;
            menu.style.top = `${rect.top + 10}px`;
            menu.classList.remove('hidden');
            menu.classList.add('show');
            
            currentLongPressItem = itemIndex;
        }

        function hideLongPressMenu() {
            const menu = document.getElementById('longPressMenu');
            menu.classList.remove('show');
            setTimeout(() => {
                menu.classList.add('hidden');
            }, 200);
        }

        function editItemFromMenu() {
            if (currentLongPressItem !== null) {
                editItem(currentLongPressItem);
            }
            hideLongPressMenu();
        }

        function addVarietyFromMenu() {
            if (currentLongPressItem !== null) {
                document.getElementById('itemName').value = items[currentLongPressItem].name;
                openAddModal();
            }
            hideLongPressMenu();
        }

        function deleteItemFromMenu() {
            if (currentLongPressItem !== null) {
                deleteItem(currentLongPressItem);
            }
            hideLongPressMenu();
        }

        // Alphabet scroll functions
        function showAlphabetScroll() {
            const alphabetScroll = document.getElementById('alphabetScroll');
            alphabetScroll.classList.add('show');
        }

        function hideAlphabetScroll() {
            setTimeout(() => {
                const alphabetScroll = document.getElementById('alphabetScroll');
                alphabetScroll.classList.remove('show');
            }, 2000);
        }

        function generateAlphabet() {
            const alphabetScroll = document.getElementById('alphabetScroll');
            const hindiAlphabet = ['‡§Ö', '‡§Ü', '‡§á', '‡§à', '‡§â', '‡§ä', '‡§è', '‡§ê', '‡§ì', '‡§î', '‡§ï', '‡§ñ', '‡§ó', '‡§ò', '‡§ö', '‡§õ', '‡§ú', '‡§ù', '‡§ü', '‡§†', '‡§°', '‡§¢', '‡§§', '‡§•', '‡§¶', '‡§ß', '‡§®', '‡§™', '‡§´', '‡§¨', '‡§≠', '‡§Æ', '‡§Ø', '‡§∞', '‡§≤', '‡§µ', '‡§∂', '‡§∑', '‡§∏', '‡§π'];
            const englishAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            const availableLetters = new Set();
            items.forEach(item => {
                const firstChar = item.name.charAt(0).toUpperCase();
                availableLetters.add(firstChar);
            });

            const allLetters = [...hindiAlphabet, ...englishAlphabet];
            
            alphabetScroll.innerHTML = allLetters.map(letter => {
                const isAvailable = availableLetters.has(letter);
                return `
                    <button ontouchstart="showLetterOverlay('${letter}')" ontouchend="hideLetterOverlay()" onclick="scrollToLetter('${letter}')" 
                            class="w-6 h-6 text-xs font-medium rounded transition duration-200 ${
                                isAvailable 
                                    ? 'text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900' 
                                    : 'text-gray-300 dark:text-gray-600 cursor-not-allowed'
                            }"
                            ${!isAvailable ? 'disabled' : ''}>
                        ${letter}
                    </button>
                `;
            }).join('');
        }

        function showLetterOverlay(letter) {
            const overlay = document.getElementById('alphabetOverlay');
            const currentLetter = document.getElementById('currentLetter');
            currentLetter.textContent = letter;
            overlay.classList.add('show');
        }

        function hideLetterOverlay() {
            setTimeout(() => {
                const overlay = document.getElementById('alphabetOverlay');
                overlay.classList.remove('show');
            }, 100);
        }

        function scrollToLetter(letter) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = letter;
            searchItems();
        }

        // Edit functions
        function editItem(index) {
            editingIndex = index;
            const item = items[index];
            
            document.getElementById('editItemName').value = item.name;
            
            const editVarietiesList = document.getElementById('editVarietiesList');
            editVarietiesList.innerHTML = item.varieties.map((variety, vIndex) => `
                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-3 mb-3">
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" value="${variety.name}" class="variety-name-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                    </div>
                    <div class="variety-rates" data-variety-index="${vIndex}">
                        ${variety.rates.map((rateInfo, rIndex) => `
                            <div class="flex space-x-2 mb-2">
                                <div class="flex-1">
                                    <input type="number" value="${rateInfo.rate}" class="rate-edit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                                </div>
                                <div class="flex-1">
                                    <select class="unit-edit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã</option>
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó</option>
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞</option>
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü</option>
                                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®" ${rateInfo.unit === '‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®' ? 'selected' : ''}>‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®</option>
                                    </select>
                                </div>
                                ${variety.rates.length > 1 ? `<button type="button" onclick="removeEditRate(this)" class="px-2 py-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded">‚ùå</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" onclick="addEditRate(${vIndex})" class="text-blue-600 dark:text-blue-400 text-sm hover:underline">+ ‡§∞‡•á‡§ü ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                </div>
            `).join('');
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function addEditRate(varietyIndex) {
            const varietyRates = document.querySelector(`[data-variety-index="${varietyIndex}"]`);
            const newRateDiv = document.createElement('div');
            newRateDiv.className = 'flex space-x-2 mb-2';
            newRateDiv.innerHTML = `
                <div class="flex-1">
                    <input type="number" class="rate-edit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="‡§∞‡•á‡§ü">
                </div>
                <div class="flex-1">
                    <select class="unit-edit-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã</option>
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ">‡§™‡•ç‡§∞‡§§‡§ø 100 ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó">‡§™‡•ç‡§∞‡§§‡§ø ‡§®‡§ó</option>
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞">‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞</option>
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•à‡§ï‡•á‡§ü</option>
                        <option value="‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®">‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú‡§®</option>
                    </select>
                </div>
                <button type="button" onclick="removeEditRate(this)" class="px-2 py-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded">‚ùå</button>
            `;
            varietyRates.appendChild(newRateDiv);
        }

        function removeEditRate(button) {
            button.closest('.flex').remove();
        }

        function updateItem() {
            const name = document.getElementById('editItemName').value.trim();
            
            if (!name) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            const varietyNameInputs = document.querySelectorAll('.variety-name-input');
            const varieties = [];

            varietyNameInputs.forEach((nameInput, vIndex) => {
                const varietyDiv = document.querySelector(`[data-variety-index="${vIndex}"]`);
                const rateInputs = varietyDiv.querySelectorAll('.rate-edit-input');
                const unitInputs = varietyDiv.querySelectorAll('.unit-edit-input');
                
                const rates = [];
                rateInputs.forEach((rateInput, rIndex) => {
                    const rate = rateInput.value.trim();
                    if (rate && !isNaN(rate) && parseFloat(rate) > 0) {
                        rates.push({
                            rate: parseFloat(rate),
                            unit: unitInputs[rIndex].value
                        });
                    }
                });

                if (rates.length > 0) {
                    varieties.push({
                        name: nameInput.value.trim() || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø',
                        rates: rates,
                        timestamp: new Date().toLocaleString('hi-IN')
                    });
                }
            });

            if (varieties.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§µ‡•à‡§∞‡§æ‡§Ø‡§ü‡•Ä ‡§î‡§∞ ‡§∞‡•á‡§ü ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            items[editingIndex] = {
                ...items[editingIndex],
                name: name,
                varieties: varieties,
                timestamp: new Date().toLocaleString('hi-IN')
            };

            items.sort((a, b) => a.name.localeCompare(b.name, 'hi'));
            saveToStorage();
            filteredItems = [...items];
            displayItems();
            generateAlphabet();
            closeEditModal();
            showNotification('‡§µ‡§∏‡•ç‡§§‡•Å ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à!');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            editingIndex = -1;
        }

        function deleteItem(index) {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                if (confirm('‡§Ø‡§π ‡§µ‡§∏‡•ç‡§§‡•Å ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡•Ä! ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç?')) {
                    if (confirm('‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä! ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                        items.splice(index, 1);
                        saveToStorage();
                        filteredItems = [...items];
                        displayItems();
                        generateAlphabet();
                        showNotification('‡§µ‡§∏‡•ç‡§§‡•Å ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à!');
                    }
                }
            }
        }

        function clearAllItems() {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å‡§ì‡§Ç ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                if (confirm('‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§ñ‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ! ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç?')) {
                    if (confirm('‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä! ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ!')) {
                        items = [];
                        filteredItems = [];
                        saveToStorage();
                        displayItems();
                        generateAlphabet();
                        document.getElementById('menuDropdown').classList.add('hidden');
                        showNotification('‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å‡§è‡§Ç ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à‡§Ç!');
                    }
                }
            }
        }

        // Receipt functions
        function openBillModal() {
            document.getElementById('billModal').classList.remove('hidden');
            document.getElementById('addMenuDropdown').classList.add('hidden');
            if (!editingReceiptId) {
                currentReceiptItems = [];
                document.getElementById('billAmount').value = '';
                document.getElementById('billProduct').value = '';
            }
            updateReceiptDisplay();
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.add('hidden');
            document.getElementById('billAmount').value = '';
            document.getElementById('billProduct').value = '';
            currentReceiptItems = [];
            editingReceiptId = null;
        }

        function focusProductInput() {
            document.getElementById('billProduct').focus();
        }

        function addBillItem() {
            const amount = document.getElementById('billAmount').value.trim();
            const product = document.getElementById('billProduct').value.trim() || '‡§∏‡§æ‡§Æ‡§æ‡§®';

            if (!amount) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•Å‡§™‡§Ø‡•á ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡•Å‡§™‡§Ø‡•á ‡§ï‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            currentReceiptItems.push({
                amount: parseFloat(amount),
                product: product
            });

            document.getElementById('billAmount').value = '';
            document.getElementById('billProduct').value = '';
            document.getElementById('billAmount').focus();
            updateReceiptDisplay();
        }

        function removeBillItem(index) {
            currentReceiptItems.splice(index, 1);
            updateReceiptDisplay();
        }

        function updateReceiptDisplay() {
            const billItems = document.getElementById('billItems');
            const billTotal = document.getElementById('billTotal');

            if (currentReceiptItems.length === 0) {
                billItems.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">‡§ï‡•ã‡§à ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</p>';
                billTotal.textContent = '‚Çπ0';
                return;
            }

            const total = currentReceiptItems.reduce((sum, item) => sum + item.amount, 0);
            billTotal.textContent = `‚Çπ${total}`;

            billItems.innerHTML = currentReceiptItems.map((item, index) => `
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                    <div class="flex-1 flex items-center">
                        <span class="font-medium text-blue-600 dark:text-blue-400 min-w-[60px]">‚Çπ${item.amount}</span>
                        <span class="text-gray-800 dark:text-white ml-4">${item.product}</span>
                    </div>
                    <button onclick="removeBillItem(${index})" class="text-red-500 hover:bg-red-100 dark:hover:bg-red-900 p-1 rounded transition duration-200">
                        ‚ùå
                    </button>
                </div>
            `).join('');
        }

        function saveBill() {
            if (currentReceiptItems.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!', true);
                return;
            }

            const total = currentReceiptItems.reduce((sum, item) => sum + item.amount, 0);
            const now = new Date();
            
            if (editingReceiptId) {
                // Update existing receipt
                const receiptIndex = receiptHistory.findIndex(r => r.id === editingReceiptId);
                if (receiptIndex !== -1) {
                    receiptHistory[receiptIndex] = {
                        ...receiptHistory[receiptIndex],
                        items: [...currentReceiptItems],
                        total: total,
                        updatedDate: now.toLocaleDateString('hi-IN'),
                        updatedTime: now.toLocaleTimeString('hi-IN')
                    };
                }
                showNotification('‡§™‡§∞‡•ç‡§ö‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à!');
            } else {
                // Create new receipt
                const receipt = {
                    id: Date.now(),
                    items: [...currentReceiptItems],
                    total: total,
                    date: now.toLocaleDateString('hi-IN'),
                    time: now.toLocaleTimeString('hi-IN')
                };
                receiptHistory.unshift(receipt);
                showNotification('‡§™‡§∞‡•ç‡§ö‡•Ä ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à!');
            }

            saveReceiptHistory();
            closeBillModal();
        }

        function printBill() {
            if (currentReceiptItems.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!', true);
                return;
            }

            try {
                const total = currentReceiptItems.reduce((sum, item) => sum + item.amount, 0);
                const now = new Date();
                
                const printContent = generateReceiptHTML(currentReceiptItems, total, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));

                // Create a safe print function
                const safePrint = () => {
                    const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
                    if (!printWindow) {
                        showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ! ‡§™‡•â‡§™‡§Ö‡§™ ‡§¨‡•ç‡§≤‡•â‡§ï‡§∞ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', true);
                        return;
                    }

                    printWindow.document.open();
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>‡§™‡§∞‡•ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</title>
                                <meta charset="UTF-8">
                                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    body { font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; padding: 10px; }
                                    @media print {
                                        body { margin: 0; }
                                        @page { margin: 0.5cm; }
                                    }
                                </style>
                            </head>
                            <body>
                                ${printContent}
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait for content to load then print
                    setTimeout(() => {
                        try {
                            printWindow.focus();
                            printWindow.print();
                        } catch (e) {
                            console.error('Print error:', e);
                        }
                    }, 1000);
                    
                    showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞!');
                };

                safePrint();
            } catch (error) {
                console.error('Print function error:', error);
                showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function shareBillPDF() {
            if (currentReceiptItems.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!', true);
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const total = currentReceiptItems.reduce((sum, item) => sum + item.amount, 0);
                const now = new Date();
                
                // Add content to PDF
                const shopName = document.getElementById('shopTitle').textContent;
                doc.setFontSize(20);
                doc.text(`${shopName} - ‡§™‡§∞‡•ç‡§ö‡•Ä`, 20, 30);
                
                doc.setFontSize(12);
                doc.text(`‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${now.toLocaleDateString('hi-IN')}`, 20, 50);
                doc.text(`‡§∏‡§Æ‡§Ø: ${now.toLocaleTimeString('hi-IN')}`, 120, 50);
                
                doc.setFontSize(14);
                doc.text('‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä:', 20, 70);
                
                let yPos = 90;
                currentReceiptItems.forEach((item, index) => {
                    doc.setFontSize(12);
                    doc.text(`${index + 1}. ‚Çπ${item.amount} - ${item.product}`, 20, yPos);
                    yPos += 15;
                });
                
                doc.setFontSize(16);
                doc.text(`‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${total}`, 20, yPos + 20);
                
                doc.text('‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Ü‡§á‡§è‡§ó‡§æ üôè', 20, yPos + 40);
                
                // Save PDF
                const fileName = `‡§™‡§∞‡•ç‡§ö‡•Ä_${now.getTime()}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
            } catch (error) {
                showNotification('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function generateReceiptHTML(items, total, date, time) {
            const shopName = document.getElementById('shopTitle').textContent;
            return `
                <div style="font-family: 'Noto Sans Devanagari', sans-serif; width: 100%; max-width: 600px; margin: 0 auto; padding: 30px; border: 2px solid #000;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 28px; font-weight: bold;">${shopName}</h2>
                        <p style="margin: 8px 0; font-size: 18px;">‡§™‡§∞‡•ç‡§ö‡•Ä/‡§∞‡§∏‡•Ä‡§¶</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; font-size: 16px; display: flex; justify-content: space-between;">
                        <span><strong>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</strong> ${date}</span>
                        <span><strong>‡§∏‡§Æ‡§Ø:</strong> ${time}</span>
                    </div>
                    
                    <div style="border-bottom: 2px solid #000; margin-bottom: 15px; padding-bottom: 15px;">
                        ${items.map(item => `
                            <div style="display: flex; margin: 12px 0; font-size: 18px; border-bottom: 1px dotted #ccc; padding-bottom: 8px; align-items: center;">
                                <span style="font-weight: bold; min-width: 80px;">‚Çπ${item.amount}</span>
                                <span style="margin-left: 20px; flex: 1;">${item.product}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; font-size: 24px; font-weight: bold; margin: 20px 0; border: 3px solid #000; padding: 15px;">
                        <p style="margin: 0;">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${total}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; font-size: 16px; color: #666;">
                        <p style="margin: 0;">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Ü‡§á‡§è‡§ó‡§æ</p>
                        <p style="margin: 8px 0; font-size: 20px;">üôè</p>
                    </div>
                </div>
            `;
        }

        function openBillHistory() {
            document.getElementById('billHistoryModal').classList.remove('hidden');
            document.getElementById('menuDropdown').classList.add('hidden');
            displayBillHistory();
        }

        function closeBillHistoryModal() {
            document.getElementById('billHistoryModal').classList.add('hidden');
        }

        function displayBillHistory() {
            const billHistoryList = document.getElementById('billHistoryList');
            
            if (receiptHistory.length === 0) {
                billHistoryList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">‡§ï‡•ã‡§à ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</p>';
                return;
            }

            billHistoryList.innerHTML = receiptHistory.map(receipt => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-blue-600 dark:text-blue-400">‚Çπ${receipt.total}</span>
                        <span class="text-sm text-gray-600 dark:text-gray-300">${receipt.date} ${receipt.time}</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                        ${receipt.items.slice(0, 2).map(item => `‚Çπ${item.amount} - ${item.product}`).join(', ')}
                        ${receipt.items.length > 2 ? ` ‡§î‡§∞ ${receipt.items.length - 2} ‡§î‡§∞...` : ''}
                    </div>
                    ${receipt.updatedDate ? `<div class="text-xs text-orange-600 dark:text-orange-400 mb-2">‡§Ö‡§™‡§°‡•á‡§ü: ${receipt.updatedDate} ${receipt.updatedTime}</div>` : ''}
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="editReceipt(${receipt.id})" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition duration-200">
                            ‚úèÔ∏è ‡§è‡§°‡§ø‡§ü
                        </button>
                        <button onclick="saveReceiptImage(${receipt.id})" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded transition duration-200">
                            üì∑ ‡§á‡§Æ‡•á‡§ú
                        </button>
                        <button onclick="reprintBill(${receipt.id})" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded transition duration-200">
                            üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
                        </button>
                        <button onclick="shareReceiptPDF(${receipt.id})" class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded transition duration-200">
                            üì§ ‡§∂‡•á‡§Ø‡§∞
                        </button>
                        <button onclick="deleteBill(${receipt.id})" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition duration-200 col-span-2">
                            üóëÔ∏è ‡§π‡§ü‡§æ‡§è‡§Ç
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editReceipt(receiptId) {
            const receipt = receiptHistory.find(r => r.id === receiptId);
            if (!receipt) return;

            editingReceiptId = receiptId;
            currentReceiptItems = [...receipt.items];
            
            closeBillHistoryModal();
            openBillModal();
        }

        function reprintBill(receiptId) {
            const receipt = receiptHistory.find(r => r.id === receiptId);
            if (!receipt) return;

            try {
                const printContent = generateReceiptHTML(receipt.items, receipt.total, receipt.date, receipt.time);

                const safePrint = () => {
                    const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
                    if (!printWindow) {
                        showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
                        return;
                    }

                    printWindow.document.open();
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>‡§™‡§∞‡•ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</title>
                                <meta charset="UTF-8">
                                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    body { font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; padding: 10px; }
                                    @media print { body { margin: 0; } @page { margin: 0.5cm; } }
                                </style>
                            </head>
                            <body>${printContent}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    setTimeout(() => {
                        try {
                            printWindow.focus();
                            printWindow.print();
                        } catch (e) {
                            console.error('Print error:', e);
                        }
                    }, 1000);
                    
                    showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞!');
                };

                safePrint();
            } catch (error) {
                console.error('Reprint error:', error);
                showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function shareReceiptPDF(receiptId) {
            const receipt = receiptHistory.find(r => r.id === receiptId);
            if (!receipt) return;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add content to PDF
                const shopName = document.getElementById('shopTitle').textContent;
                doc.setFontSize(20);
                doc.text(`${shopName} - ‡§™‡§∞‡•ç‡§ö‡•Ä`, 20, 30);
                
                doc.setFontSize(12);
                doc.text(`‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${receipt.date}`, 20, 50);
                doc.text(`‡§∏‡§Æ‡§Ø: ${receipt.time}`, 120, 50);
                
                doc.setFontSize(14);
                doc.text('‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä:', 20, 70);
                
                let yPos = 90;
                receipt.items.forEach((item, index) => {
                    doc.setFontSize(12);
                    doc.text(`${index + 1}. ‚Çπ${item.amount} - ${item.product}`, 20, yPos);
                    yPos += 15;
                });
                
                doc.setFontSize(16);
                doc.text(`‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${receipt.total}`, 20, yPos + 20);
                
                doc.text('‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Ü‡§á‡§è‡§ó‡§æ üôè', 20, yPos + 40);
                
                // Save PDF
                const fileName = `‡§™‡§∞‡•ç‡§ö‡•Ä_${receipt.date.replace(/\//g, '-')}_${receipt.id}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
            } catch (error) {
                showNotification('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function deleteBill(receiptId) {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                receiptHistory = receiptHistory.filter(receipt => receipt.id !== receiptId);
                saveReceiptHistory();
                displayBillHistory();
                showNotification('‡§™‡§∞‡•ç‡§ö‡•Ä ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à!');
            }
        }

        // Bakaya functions
        function openBakayaModal() {
            document.getElementById('bakayaModal').classList.remove('hidden');
            document.getElementById('addMenuDropdown').classList.add('hidden');
            if (!editingBakayaId) {
                clearBakayaForm();
            }
        }

        function closeBakayaModal() {
            document.getElementById('bakayaModal').classList.add('hidden');
            clearBakayaForm();
            editingBakayaId = null;
        }

        function clearBakayaForm() {
            document.getElementById('bakayaName').value = '';
            document.getElementById('bakayaAmount').value = '';
            document.getElementById('bakayaDescription').value = '';
        }

        function saveBakaya() {
            const name = document.getElementById('bakayaName').value.trim() || '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï';
            const amount = document.getElementById('bakayaAmount').value.trim();
            const description = document.getElementById('bakayaDescription').value.trim();

            if (!amount) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            const now = new Date();
            
            if (editingBakayaId) {
                // Update existing bakaya
                const bakayaIndex = bakayaHistory.findIndex(b => b.id === editingBakayaId);
                if (bakayaIndex !== -1) {
                    bakayaHistory[bakayaIndex] = {
                        ...bakayaHistory[bakayaIndex],
                        name: name,
                        amount: parseFloat(amount),
                        description: description,
                        updatedDate: now.toLocaleDateString('hi-IN'),
                        updatedTime: now.toLocaleTimeString('hi-IN')
                    };
                }
                showNotification('‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!');
            } else {
                // Create new bakaya
                const bakaya = {
                    id: Date.now(),
                    name: name,
                    amount: parseFloat(amount),
                    description: description,
                    date: now.toLocaleDateString('hi-IN'),
                    time: now.toLocaleTimeString('hi-IN')
                };
                bakayaHistory.unshift(bakaya);
                showNotification('‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!');
            }

            saveBakayaHistory();
            closeBakayaModal();
        }

        function printBakaya() {
            const name = document.getElementById('bakayaName').value.trim();
            const amount = document.getElementById('bakayaAmount').value.trim();
            const description = document.getElementById('bakayaDescription').value.trim();

            if (!name || !amount) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§∞‡§æ‡§∂‡§ø ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            try {
                const now = new Date();
                const printContent = generateBakayaHTML(name, parseFloat(amount), description, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));

                const safePrint = () => {
                    const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
                    if (!printWindow) {
                        showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ! ‡§™‡•â‡§™‡§Ö‡§™ ‡§¨‡•ç‡§≤‡•â‡§ï‡§∞ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', true);
                        return;
                    }

                    printWindow.document.open();
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</title>
                                <meta charset="UTF-8">
                                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    body { font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; padding: 10px; }
                                    @media print {
                                        body { margin: 0; }
                                        @page { margin: 0.5cm; }
                                    }
                                </style>
                            </head>
                            <body>
                                ${printContent}
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    setTimeout(() => {
                        try {
                            printWindow.focus();
                            printWindow.print();
                        } catch (e) {
                            console.error('Print error:', e);
                        }
                    }, 1000);
                    
                    showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞!');
                };

                safePrint();
            } catch (error) {
                console.error('Bakaya print error:', error);
                showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function shareBakayaPDF() {
            const name = document.getElementById('bakayaName').value.trim();
            const amount = document.getElementById('bakayaAmount').value.trim();
            const description = document.getElementById('bakayaDescription').value.trim();

            if (!name || !amount) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§∞‡§æ‡§∂‡§ø ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const now = new Date();
                
                // Add content to PDF
                const shopName = document.getElementById('shopTitle').textContent;
                doc.setFontSize(20);
                doc.text(`${shopName} - ‡§¨‡§ï‡§æ‡§Ø‡§æ`, 20, 30);
                
                doc.setFontSize(12);
                doc.text(`‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${now.toLocaleDateString('hi-IN')}`, 20, 50);
                doc.text(`‡§∏‡§Æ‡§Ø: ${now.toLocaleTimeString('hi-IN')}`, 120, 50);
                
                doc.setFontSize(16);
                doc.text(`‡§¨‡§ï‡§æ‡§Ø‡§æ‡§ï‡§∞‡•ç‡§§‡§æ: ${name}`, 20, 80);
                
                doc.setFontSize(18);
                doc.text(`‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${parseFloat(amount)}`, 20, 110);
                
                if (description) {
                    doc.setFontSize(12);
                    doc.text('‡§µ‡§ø‡§µ‡§∞‡§£:', 20, 140);
                    doc.text(description, 20, 155);
                }
                
                doc.setFontSize(12);
                doc.text('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 20, 200);
                doc.text('‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè', 20, 220);
                
                // Save PDF
                const fileName = `‡§¨‡§ï‡§æ‡§Ø‡§æ_${name}_${now.getTime()}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
            } catch (error) {
                showNotification('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function generateBakayaHTML(name, amount, description, date, time) {
            const shopName = document.getElementById('shopTitle').textContent;
            return `
                <div style="font-family: 'Noto Sans Devanagari', sans-serif; width: 100%; max-width: 600px; margin: 0 auto; padding: 30px; border: 2px solid #000;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 28px; font-weight: bold;">${shopName}</h2>
                        <p style="margin: 8px 0; font-size: 18px;">‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§∏‡•Ä‡§¶</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; font-size: 16px; display: flex; justify-content: space-between;">
                        <span><strong>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</strong> ${date}</span>
                        <span><strong>‡§∏‡§Æ‡§Ø:</strong> ${time}</span>
                    </div>
                    
                    <div style="margin-bottom: 25px; padding: 20px; border: 2px solid #ccc; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                            ‡§¨‡§ï‡§æ‡§Ø‡§æ‡§ï‡§∞‡•ç‡§§‡§æ: ${name}
                        </div>
                        
                        <div style="font-size: 26px; font-weight: bold; color: #d32f2f; text-align: center; margin: 20px 0; padding: 15px; border: 3px solid #d32f2f; border-radius: 8px;">
                            ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${amount}
                        </div>
                        
                        ${description ? `
                            <div style="margin-top: 20px;">
                                <strong style="font-size: 16px;">‡§µ‡§ø‡§µ‡§∞‡§£:</strong><br>
                                <span style="font-size: 16px; margin-top: 8px; display: block;">${description}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; font-size: 16px; color: #666;">
                        <p style="margin: 0; font-weight: bold;">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                        <p style="margin: 8px 0; font-size: 20px;">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè</p>
                    </div>
                </div>
            `;
        }

        function openBakayaHistory() {
            document.getElementById('bakayaHistoryModal').classList.remove('hidden');
            document.getElementById('bakayaHistoryModal').classList.add('flex');
            document.getElementById('menuDropdown').classList.add('hidden');
            displayBakayaHistory();
        }

        function closeBakayaHistoryModal() {
            document.getElementById('bakayaHistoryModal').classList.add('hidden');
            document.getElementById('bakayaHistoryModal').classList.remove('flex');
        }

        function displayBakayaHistory() {
            const bakayaHistoryList = document.getElementById('bakayaHistoryList');
            
            if (bakayaHistory.length === 0) {
                bakayaHistoryList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">‡§ï‡•ã‡§à ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</p>';
                return;
            }

            const totalBakaya = bakayaHistory.reduce((sum, bakaya) => sum + bakaya.amount, 0);

            bakayaHistoryList.innerHTML = `
                <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <span class="text-lg font-bold text-red-600 dark:text-red-400">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ‚Çπ${totalBakaya}</span>
                    </div>
                </div>
                ${bakayaHistory.map(bakaya => `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-red-600 dark:text-red-400">‚Çπ${bakaya.amount}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-300">${bakaya.date} ${bakaya.time}</span>
                        </div>
                        <div class="text-lg font-medium text-gray-800 dark:text-white mb-2">${bakaya.name}</div>
                        ${bakaya.description ? `<div class="text-sm text-gray-600 dark:text-gray-300 mb-2">${bakaya.description}</div>` : ''}
                        ${bakaya.updatedDate ? `<div class="text-xs text-orange-600 dark:text-orange-400 mb-2">‡§Ö‡§™‡§°‡•á‡§ü: ${bakaya.updatedDate} ${bakaya.updatedTime}</div>` : ''}
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="editBakaya(${bakaya.id})" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition duration-200">
                                ‚úèÔ∏è ‡§è‡§°‡§ø‡§ü
                            </button>
                            <button onclick="saveBakayaHistoryImage(${bakaya.id})" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded transition duration-200">
                                üì∑ ‡§á‡§Æ‡•á‡§ú
                            </button>
                            <button onclick="reprintBakaya(${bakaya.id})" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded transition duration-200">
                                üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
                            </button>
                            <button onclick="shareBakayaHistoryPDF(${bakaya.id})" class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded transition duration-200">
                                üì§ ‡§∂‡•á‡§Ø‡§∞
                            </button>
                            <button onclick="deleteBakaya(${bakaya.id})" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition duration-200 col-span-2">
                                üóëÔ∏è ‡§π‡§ü‡§æ‡§è‡§Ç
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function editBakaya(bakayaId) {
            const bakaya = bakayaHistory.find(b => b.id === bakayaId);
            if (!bakaya) return;

            editingBakayaId = bakayaId;
            document.getElementById('bakayaName').value = bakaya.name;
            document.getElementById('bakayaAmount').value = bakaya.amount;
            document.getElementById('bakayaDescription').value = bakaya.description || '';
            
            closeBakayaHistoryModal();
            openBakayaModal();
        }

        function reprintBakaya(bakayaId) {
            const bakaya = bakayaHistory.find(b => b.id === bakayaId);
            if (!bakaya) return;

            try {
                const printContent = generateBakayaHTML(bakaya.name, bakaya.amount, bakaya.description, bakaya.date, bakaya.time);

                const safePrint = () => {
                    const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
                    if (!printWindow) {
                        showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
                        return;
                    }

                    printWindow.document.open();
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</title>
                                <meta charset="UTF-8">
                                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    body { font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; padding: 10px; }
                                    @media print { body { margin: 0; } @page { margin: 0.5cm; } }
                                </style>
                            </head>
                            <body>${printContent}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    setTimeout(() => {
                        try {
                            printWindow.focus();
                            printWindow.print();
                        } catch (e) {
                            console.error('Print error:', e);
                        }
                    }, 1000);
                    
                    showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞!');
                };

                safePrint();
            } catch (error) {
                console.error('Bakaya reprint error:', error);
                showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function shareBakayaHistoryPDF(bakayaId) {
            const bakaya = bakayaHistory.find(b => b.id === bakayaId);
            if (!bakaya) return;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add content to PDF
                const shopName = document.getElementById('shopTitle').textContent;
                doc.setFontSize(20);
                doc.text(`${shopName} - ‡§¨‡§ï‡§æ‡§Ø‡§æ`, 20, 30);
                
                doc.setFontSize(12);
                doc.text(`‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${bakaya.date}`, 20, 50);
                doc.text(`‡§∏‡§Æ‡§Ø: ${bakaya.time}`, 120, 50);
                
                doc.setFontSize(16);
                doc.text(`‡§¨‡§ï‡§æ‡§Ø‡§æ‡§ï‡§∞‡•ç‡§§‡§æ: ${bakaya.name}`, 20, 80);
                
                doc.setFontSize(18);
                doc.text(`‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${bakaya.amount}`, 20, 110);
                
                if (bakaya.description) {
                    doc.setFontSize(12);
                    doc.text('‡§µ‡§ø‡§µ‡§∞‡§£:', 20, 140);
                    doc.text(bakaya.description, 20, 155);
                }
                
                doc.setFontSize(12);
                doc.text('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 20, 200);
                doc.text('‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè', 20, 220);
                
                // Save PDF
                const fileName = `‡§¨‡§ï‡§æ‡§Ø‡§æ_${bakaya.name}_${bakaya.date.replace(/\//g, '-')}_${bakaya.id}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
            } catch (error) {
                showNotification('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function deleteBakaya(bakayaId) {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                bakayaHistory = bakayaHistory.filter(bakaya => bakaya.id !== bakayaId);
                saveBakayaHistory();
                displayBakayaHistory();
                showNotification('‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à!');
            }
        }

        // Calculator functions
        function openCalculator() {
            document.getElementById('calculatorModal').classList.remove('hidden');
            document.getElementById('menuDropdown').classList.add('hidden');
            clearCalc();
        }

        function closeCalculator() {
            document.getElementById('calculatorModal').classList.add('hidden');
        }

        function clearCalc() {
            calcExpression = '';
            calcResult = '';
            calcSteps = [];
            currentStepIndex = 0;
            document.getElementById('calcDisplay').value = '0';
            updateCalcHistory();
        }

        function deleteLast() {
            if (calcExpression.length > 0) {
                calcExpression = calcExpression.slice(0, -1);
                document.getElementById('calcDisplay').value = calcExpression || '0';
            }
        }

        function appendToCalc(value) {
            if (calcResult && !isNaN(value)) {
                // If there's a result and user enters a number, start fresh
                calcExpression = value;
                calcResult = '';
            } else if (calcResult && isNaN(value)) {
                // If there's a result and user enters an operator, continue with result
                calcExpression = calcResult + value;
                calcResult = '';
            } else {
                calcExpression += value;
            }
            
            document.getElementById('calcDisplay').value = calcExpression;
        }

        function calculateResult() {
            if (!calcExpression) return;
            
            try {
                // Replace display symbols with actual operators
                let expression = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/');
                
                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();
                
                if (isFinite(result)) {
                    // Round to 2 decimal places if needed
                    result = Math.round(result * 100) / 100;
                    calcResult = result.toString();
                    document.getElementById('calcDisplay').value = calcResult;
                    
                    // Add step to history
                    addCalcStep(calcExpression, calcResult);
                    
                    calcExpression = calcResult; // Keep result for next calculation
                } else {
                    document.getElementById('calcDisplay').value = 'Error';
                    calcExpression = '';
                    calcResult = '';
                }
            } catch (error) {
                document.getElementById('calcDisplay').value = 'Error';
                calcExpression = '';
                calcResult = '';
            }
        }

        let calcSteps = [];
        let currentStepIndex = 0;

        function checkTotal() {
            if (calcSteps.length === 0) {
                const currentValue = document.getElementById('calcDisplay').value;
                if (currentValue && currentValue !== '0' && currentValue !== 'Error') {
                    showNotification(`‚úì ‡§ö‡•á‡§ï: ‚Çπ${currentValue}`, false);
                } else {
                    showNotification('‡§ï‡•ã‡§à ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!', true);
                }
                return;
            }
            
            // Show current step
            if (currentStepIndex < calcSteps.length) {
                const step = calcSteps[currentStepIndex];
                showNotification(`‡§∏‡•ç‡§ü‡•á‡§™ ${currentStepIndex + 1}: ${step}`, false);
                currentStepIndex++;
            } else {
                // Reset to beginning
                currentStepIndex = 0;
                const step = calcSteps[currentStepIndex];
                showNotification(`‡§∏‡•ç‡§ü‡•á‡§™ ${currentStepIndex + 1}: ${step}`, false);
                currentStepIndex++;
            }
        }

        function updateCalcHistory() {
            const historyDiv = document.getElementById('calcHistory');
            if (calcSteps.length === 0) {
                historyDiv.innerHTML = '<div class="text-center text-gray-400">‡§ï‡•ã‡§à ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç</div>';
            } else {
                historyDiv.innerHTML = calcSteps.map((step, index) => 
                    `<div class="text-right ${index === calcSteps.length - 1 ? 'font-semibold text-blue-600 dark:text-blue-400' : ''}">${step}</div>`
                ).join('');
            }
        }

        function addCalcStep(expression, result) {
            calcSteps.push(`${expression} = ${result}`);
            if (calcSteps.length > 10) {
                calcSteps.shift();
            }
            updateCalcHistory();
        }

        // New menu functions
        function toggleAddMenu() {
            const addMenu = document.getElementById('addMenuDropdown');
            addMenu.classList.toggle('hidden');
        }

        function showItemHistory() {
            if (currentLongPressItem !== null) {
                const item = items[currentLongPressItem];
                let historyText = `üìä ${item.name} ‡§ï‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä:\n\n`;
                
                if (item.varieties && item.varieties.length > 0) {
                    item.varieties.forEach((variety, index) => {
                        historyText += `${index + 1}. ${variety.name}\n`;
                        if (variety.rates && variety.rates.length > 0) {
                            variety.rates.forEach((rate, rIndex) => {
                                historyText += `   ‚Ä¢ ‚Çπ${rate.rate} ${rate.unit}\n`;
                            });
                        }
                        if (variety.timestamp) {
                            historyText += `   üìÖ ${variety.timestamp}\n`;
                        }
                        historyText += '\n';
                    });
                } else {
                    historyText += '‡§ï‡•ã‡§à ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§';
                }
                
                alert(historyText);
            }
            hideLongPressMenu();
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('menuDropdown');
            const addMenu = document.getElementById('addMenuDropdown');
            const longPressMenu = document.getElementById('longPressMenu');
            
            if (!e.target.closest('#menuDropdown') && !e.target.closest('button[onclick="toggleMenu()"]')) {
                menu.classList.add('hidden');
            }
            
            if (!e.target.closest('#addMenuDropdown') && !e.target.closest('button[onclick="toggleAddMenu()"]')) {
                addMenu.classList.add('hidden');
            }
            
            if (!e.target.closest('#longPressMenu')) {
                hideLongPressMenu();
            }
        });

        // Close modals when clicking outside
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        document.getElementById('billModal').addEventListener('click', function(e) {
            if (e.target === this) closeBillModal();
        });

        document.getElementById('bakayaModal').addEventListener('click', function(e) {
            if (e.target === this) closeBakayaModal();
        });

        document.getElementById('billHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeBillHistoryModal();
        });

        document.getElementById('bakayaHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeBakayaHistoryModal();
        });

        document.getElementById('calculatorModal').addEventListener('click', function(e) {
            if (e.target === this) closeCalculator();
        });

        document.getElementById('allItemsModal').addEventListener('click', function(e) {
            if (e.target === this) closeAllItemsView();
        });

        // Keyboard support for calculator
        document.addEventListener('keydown', function(e) {
            const calcModal = document.getElementById('calculatorModal');
            if (!calcModal.classList.contains('hidden')) {
                e.preventDefault();
                
                if (e.key >= '0' && e.key <= '9') {
                    appendToCalc(e.key);
                } else if (e.key === '.') {
                    appendToCalc('.');
                } else if (e.key === '+') {
                    appendToCalc('+');
                } else if (e.key === '-') {
                    appendToCalc('-');
                } else if (e.key === '*') {
                    appendToCalc('√ó');
                } else if (e.key === '/') {
                    appendToCalc('√∑');
                } else if (e.key === 'Enter' || e.key === '=') {
                    calculateResult();
                } else if (e.key === 'Escape') {
                    closeCalculator();
                } else if (e.key === 'Backspace') {
                    deleteLast();
                } else if (e.key === 'Delete' || e.key.toLowerCase() === 'c') {
                    clearCalc();
                }
            }
        });

        // All items view functions
        function openAllItemsView() {
            document.getElementById('allItemsModal').classList.remove('hidden');
            document.getElementById('menuDropdown').classList.add('hidden');
            displayAllItems();
        }

        function closeAllItemsView() {
            document.getElementById('allItemsModal').classList.add('hidden');
        }

        function displayAllItems() {
            const allItemsList = document.getElementById('allItemsList');
            const totalItemsCount = document.getElementById('totalItemsCount');
            
            totalItemsCount.textContent = items.length;
            
            if (items.length === 0) {
                allItemsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">‡§ï‡•ã‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</p>';
                return;
            }

            allItemsList.innerHTML = items.map((item, index) => `
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm border border-gray-100 dark:border-gray-600 p-4">
                    <h3 class="font-semibold text-gray-800 dark:text-white text-lg mb-2">${index + 1}. ${item.name}</h3>
                    <div class="space-y-2">
                        ${item.varieties.map(variety => `
                            <div class="variety-item">
                                ${variety.name !== '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø' ? `<div class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">${variety.name}</div>` : ''}
                                <div class="flex flex-wrap gap-2">
                                    ${variety.rates.map(rateInfo => `
                                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-sm font-medium">
                                            ‚Çπ${rateInfo.rate} ${rateInfo.unit}
                                        </span>
                                    `).join('')}
                                </div>
                                ${variety.timestamp ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">üìÖ ${variety.timestamp}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function shareAllItemsPDF() {
            if (items.length === 0) {
                showNotification('‡§ï‡•ã‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!', true);
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const shopName = document.getElementById('shopTitle').textContent;
                const now = new Date();
                
                // Add content to PDF
                doc.setFontSize(20);
                doc.text(`${shopName} - ‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§∏‡•Ç‡§ö‡•Ä`, 20, 30);
                
                doc.setFontSize(12);
                doc.text(`‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${now.toLocaleDateString('hi-IN')}`, 20, 50);
                doc.text(`‡§∏‡§Æ‡§Ø: ${now.toLocaleTimeString('hi-IN')}`, 120, 50);
                doc.text(`‡§ï‡•Å‡§≤ ‡§µ‡§∏‡•ç‡§§‡•Å‡§è‡§Ç: ${items.length}`, 20, 65);
                
                let yPos = 85;
                items.forEach((item, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text(`${index + 1}. ${item.name}`, 20, yPos);
                    yPos += 15;
                    
                    item.varieties.forEach(variety => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFontSize(10);
                        if (variety.name !== '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø') {
                            doc.text(`   ${variety.name}:`, 25, yPos);
                            yPos += 10;
                        }
                        
                        variety.rates.forEach(rate => {
                            if (yPos > 250) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(`     ‚Çπ${rate.rate} ${rate.unit}`, 30, yPos);
                            yPos += 8;
                        });
                        yPos += 5;
                    });
                    yPos += 5;
                });
                
                // Save PDF
                const fileName = `‡§∏‡§≠‡•Ä_‡§µ‡§∏‡•ç‡§§‡•Å_‡§∏‡•Ç‡§ö‡•Ä_${now.getTime()}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
            } catch (error) {
                showNotification('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        // Theme functions
        let currentTheme = 'auto';
        
        function toggleThemeMenu() {
            const themeSubmenu = document.getElementById('themeSubmenu');
            themeSubmenu.classList.toggle('hidden');
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('selectedTheme', theme);
            applyTheme(theme);
            document.getElementById('themeSubmenu').classList.add('hidden');
            document.getElementById('menuDropdown').classList.add('hidden');
            showNotification(`${getThemeName(theme)} ‡§•‡•Ä‡§Æ ‡§≤‡§ó‡§æ‡§à ‡§ó‡§à!`);
        }
        
        function getThemeName(theme) {
            const themeNames = {
                'auto': '‡§ë‡§ü‡•ã',
                'light': '‡§≤‡§æ‡§á‡§ü',
                'dark': '‡§°‡§æ‡§∞‡•ç‡§ï',
                'grayscale': '‡§ó‡•ç‡§∞‡•á ‡§∏‡•ç‡§ï‡•á‡§≤'
            };
            return themeNames[theme] || theme;
        }
        
        function applyTheme(theme) {
            const body = document.body;
            
            // Remove all theme classes
            body.className = body.className.replace(/theme-\w+/g, '').replace(/dark/g, '').trim();
            
            if (theme === 'auto') {
                // Use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('theme-dark');
                } else {
                    body.classList.add('theme-light');
                }
            } else if (theme === 'dark') {
                body.classList.add('theme-dark');
            } else if (theme === 'light') {
                body.classList.add('theme-light');
            } else if (theme === 'grayscale') {
                body.classList.add('theme-grayscale');
            }
        }
        
        // Shop name functions
        function editShopName() {
            const currentName = document.getElementById('shopTitle').textContent;
            const newName = prompt('‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:', currentName);
            
            if (newName && newName.trim() !== '') {
                document.getElementById('shopTitle').textContent = newName.trim();
                localStorage.setItem('shopName', newName.trim());
                showNotification('‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
            }
            document.getElementById('menuDropdown').classList.add('hidden');
        }
        
        // Print all items function
        function printAllItems() {
            if (items.length === 0) {
                showNotification('‡§ï‡•ã‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!', true);
                return;
            }
            
            try {
                const shopName = document.getElementById('shopTitle').textContent;
                const now = new Date();
                const printContent = generateAllItemsHTML(items, shopName, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));

                const safePrint = () => {
                    const printWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                    if (!printWindow) {
                        showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
                        return;
                    }

                    printWindow.document.open();
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§∏‡•Ç‡§ö‡•Ä</title>
                                <meta charset="UTF-8">
                                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
                                <style>
                                    body { font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; padding: 10px; }
                                    @media print { body { margin: 0; } @page { margin: 0.5cm; } }
                                </style>
                            </head>
                            <body>${printContent}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    setTimeout(() => {
                        try {
                            printWindow.focus();
                            printWindow.print();
                        } catch (e) {
                            console.error('Print error:', e);
                        }
                    }, 1000);
                    
                    showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞!');
                };

                safePrint();
            } catch (error) {
                console.error('Print all items error:', error);
                showNotification('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
            
            document.getElementById('menuDropdown').classList.add('hidden');
        }
        
        function generateAllItemsHTML(items, shopName, date, time) {
            return `
                <div style="font-family: 'Noto Sans Devanagari', sans-serif; width: 100%; max-width: 900px; margin: 0 auto; padding: 30px;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 25px;">
                        <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${shopName}</h1>
                        <p style="margin: 8px 0; font-size: 20px;">‡§∏‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å‡§ì‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</p>
                        <p style="margin: 8px 0; font-size: 16px;">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${date} | ‡§∏‡§Æ‡§Ø: ${time}</p>
                    </div>
                    
                    <div style="margin-bottom: 25px; text-align: center;">
                        <p style="font-size: 20px; font-weight: bold; color: #007bff;">‡§ï‡•Å‡§≤ ‡§µ‡§∏‡•ç‡§§‡•Å‡§è‡§Ç: ${items.length}</p>
                    </div>
                    
                    ${items.map((item, index) => `
                        <div style="border: 2px solid #ccc; margin-bottom: 20px; padding: 20px; border-radius: 12px; background-color: #fafafa;">
                            <h3 style="margin: 0 0 15px 0; font-size: 22px; font-weight: bold; color: #333;">${index + 1}. ${item.name}</h3>
                            ${item.varieties.map(variety => `
                                <div style="margin-left: 25px; margin-bottom: 12px; padding: 12px; background-color: #f0f8ff; border-left: 4px solid #007bff; border-radius: 6px;">
                                    ${variety.name !== '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø' ? `<div style="font-weight: bold; margin-bottom: 8px; color: #555; font-size: 16px;">${variety.name}</div>` : ''}
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        ${variety.rates.map(rateInfo => `
                                            <span style="background-color: #007bff; color: white; padding: 6px 12px; border-radius: 15px; font-size: 16px; font-weight: bold;">
                                                ‚Çπ${rateInfo.rate} ${rateInfo.unit}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                    
                    <div style="text-align: center; margin-top: 40px; font-size: 16px; color: #666; border-top: 2px solid #ccc; padding-top: 20px;">
                        <p style="margin: 0;">‡§¶‡•Å‡§ï‡§æ‡§® ‡§∞‡•á‡§ü ‡§ê‡§™ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞</p>
                        <p style="margin: 8px 0; font-size: 20px;">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè</p>
                    </div>
                </div>
            `;
        }


        // Back button functionality
        function handleBackButton() {
            // Close any open modals
            const modals = ['addModal', 'editModal', 'billModal', 'bakayaModal', 'billHistoryModal', 'bakayaHistoryModal', 'calculatorModal', 'allItemsModal'];
            let modalClosed = false;
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // Call specific close functions to clean up
                    if (modalId === 'addModal') closeAddModal();
                    else if (modalId === 'editModal') closeEditModal();
                    else if (modalId === 'billModal') closeBillModal();
                    else if (modalId === 'bakayaModal') closeBakayaModal();
                    else if (modalId === 'billHistoryModal') closeBillHistoryModal();
                    else if (modalId === 'bakayaHistoryModal') closeBakayaHistoryModal();
                    else if (modalId === 'calculatorModal') closeCalculator();
                    else if (modalId === 'allItemsModal') closeAllItemsView();
                    
                    modalClosed = true;
                }
            });
            
            // Close menus
            const menu = document.getElementById('menuDropdown');
            const addMenu = document.getElementById('addMenuDropdown');
            const themeMenu = document.getElementById('themeSubmenu');
            
            if (!menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                modalClosed = true;
            }
            if (!addMenu.classList.contains('hidden')) {
                addMenu.classList.add('hidden');
                modalClosed = true;
            }
            if (!themeMenu.classList.contains('hidden')) {
                themeMenu.classList.add('hidden');
                modalClosed = true;
            }
            
            return modalClosed;
        }

        // Handle browser back button
        window.addEventListener('popstate', function(e) {
            if (handleBackButton()) {
                history.pushState(null, null, location.href);
            }
        });

        // Image save functions
        function createImageFromHTML(htmlContent, filename) {
            try {
                // Create a temporary div
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '-9999px';
                tempDiv.style.background = 'white';
                document.body.appendChild(tempDiv);

                // Use html2canvas if available, otherwise fallback
                if (window.html2canvas) {
                    html2canvas(tempDiv, {
                        backgroundColor: 'white',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true
                    }).then(canvas => {
                        // Create download link
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        
                        document.body.removeChild(tempDiv);
                        showNotification('‡§á‡§Æ‡•á‡§ú ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
                    }).catch(error => {
                        document.body.removeChild(tempDiv);
                        showNotification('‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
                    });
                } else {
                    // Fallback: Create a simple canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 600;
                    canvas.height = 800;
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'black';
                    ctx.font = '16px Arial';
                    ctx.fillText('‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è html2canvas ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è', 50, 100);
                    
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    document.body.removeChild(tempDiv);
                    showNotification('‡§¨‡•á‡§∏‡§ø‡§ï ‡§á‡§Æ‡•á‡§ú ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!');
                }
            } catch (error) {
                showNotification('‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!', true);
            }
        }

        function saveBillImage() {
            if (currentReceiptItems.length === 0) {
                showNotification('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!', true);
                return;
            }

            const total = currentReceiptItems.reduce((sum, item) => sum + item.amount, 0);
            const now = new Date();
            const htmlContent = generateReceiptHTML(currentReceiptItems, total, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));
            const filename = `‡§™‡§∞‡•ç‡§ö‡•Ä_${now.getTime()}.png`;
            
            createImageFromHTML(htmlContent, filename);
        }

        function saveBakayaImage() {
            const name = document.getElementById('bakayaName').value.trim() || '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï';
            const amount = document.getElementById('bakayaAmount').value.trim();
            const description = document.getElementById('bakayaDescription').value.trim();

            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!', true);
                return;
            }

            const now = new Date();
            const htmlContent = generateBakayaHTML(name, parseFloat(amount), description, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));
            const filename = `‡§¨‡§ï‡§æ‡§Ø‡§æ_${name}_${now.getTime()}.png`;
            
            createImageFromHTML(htmlContent, filename);
        }

        function saveAllItemsImage() {
            if (items.length === 0) {
                showNotification('‡§ï‡•ã‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!', true);
                return;
            }

            const shopName = document.getElementById('shopTitle').textContent;
            const now = new Date();
            const htmlContent = generateAllItemsHTML(items, shopName, now.toLocaleDateString('hi-IN'), now.toLocaleTimeString('hi-IN'));
            const filename = `‡§∏‡§≠‡•Ä_‡§µ‡§∏‡•ç‡§§‡•Å_‡§∏‡•Ç‡§ö‡•Ä_${now.getTime()}.png`;
            
            createImageFromHTML(htmlContent, filename);
        }

        function saveReceiptImage(receiptId) {
            const receipt = receiptHistory.find(r => r.id === receiptId);
            if (!receipt) return;

            const htmlContent = generateReceiptHTML(receipt.items, receipt.total, receipt.date, receipt.time);
            const filename = `‡§™‡§∞‡•ç‡§ö‡•Ä_${receipt.date.replace(/\//g, '-')}_${receipt.id}.png`;
            
            createImageFromHTML(htmlContent, filename);
        }

        function saveBakayaHistoryImage(bakayaId) {
            const bakaya = bakayaHistory.find(b => b.id === bakayaId);
            if (!bakaya) return;

            const htmlContent = generateBakayaHTML(bakaya.name, bakaya.amount, bakaya.description, bakaya.date, bakaya.time);
            const filename = `‡§¨‡§ï‡§æ‡§Ø‡§æ_${bakaya.name}_${bakaya.date.replace(/\//g, '-')}_${bakaya.id}.png`;
            
            createImageFromHTML(htmlContent, filename);
        }

        // Initialize the app when page loads
        window.addEventListener('load', function() {
            try {
                initApp();
                // Push initial state for back button handling
                history.pushState(null, null, location.href);
                
                // Load html2canvas library for image generation
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    console.log('html2canvas loaded successfully');
                };
                script.onerror = function() {
                    console.log('html2canvas failed to load, using fallback');
                };
                document.head.appendChild(script);
            } catch (error) {
                console.error('App initialization error:', error);
                showNotification('‡§ê‡§™ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', true);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c6559991df45ed',t:'MTc1NDczMjg3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
